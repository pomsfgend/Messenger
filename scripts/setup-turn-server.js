// scripts/setup-turn-server.js
const fs = require('fs');
const path = require('path');
const crypto = require('crypto');
const { execSync } = require('child_process');

console.log('--- Setting up TURN Server Configuration ---');

// 1. Check for Docker and ensure the daemon is running
try {
    // Use 'docker info' as it checks for a connection to the daemon, not just CLI existence.
    execSync('docker info', { stdio: 'pipe' });
    console.log('âœ… Docker installation found and daemon is responsive.');
} catch (error) {
    console.error('\nðŸ”´ ERROR: Could not connect to the Docker daemon.');
    console.error('Please ensure Docker Desktop is installed AND RUNNING before you continue.');
    console.error('If it is installed, please start it now and then re-run this setup script (`npm run setup`).');
    console.error('Download Docker Desktop here: https://www.docker.com/products/docker-desktop/');
    process.exit(1);
}

// 2. Generate Secret
const randomSecret = crypto.randomBytes(32).toString('hex');
console.log('âœ… Generated new secure TURN secret.');

// 3. Create turnserver.conf
const turnConfigPath = path.resolve(__dirname, '..', 'turnserver.conf');
const turnConfigContent = `
# This file is auto-generated by a setup script.
# Do not edit this file manually unless you know what you are doing.

listening-port=3478
tls-listening-port=5349
fingerprint
lt-cred-mech
use-auth-secret
static-auth-secret=${randomSecret}
realm=yourdomain.com
no-tcp-relay
# The following options are commented out as they might restrict connectivity in some networks.
# Consider enabling them for a relay-only setup if you have a separate STUN server.
# no-stun
# no-udp-relay
# relay-only
`.trim();

try {
    fs.writeFileSync(turnConfigPath, turnConfigContent, 'utf8');
    console.log(`âœ… Configuration file created at: ${turnConfigPath}`);
} catch (error) {
    console.error(`\nðŸ”´ ERROR: Could not write configuration file to ${turnConfigPath}`);
    console.error(error);
    process.exit(1);
}

// 4. Provide Docker run command
const absoluteTurnConfigPath = path.resolve(turnConfigPath);
const dockerCommand = `docker run -d --name=turn-server -p 3478:3478 -p 3478:3478/udp -p 5349:5349 -p 5349:5349/udp -v "${absoluteTurnConfigPath}:/etc/coturn/turnserver.conf" instrumentisto/coturn`;

console.log('\n--- âœ… Configuration Complete! ---');
console.log('\nNext Step: Run the TURN server in Docker.');
console.log('IMPORTANT: Ensure Docker Desktop is running.');
console.log('Copy and paste the following command into your terminal (CMD or PowerShell) and press Enter:\n');
console.log('------------------------------------------------------------------');
console.log(dockerCommand);
console.log('------------------------------------------------------------------');
console.log('\nAfter running the Docker command, your setup is complete and you can start the application with `npm run dev`.');
